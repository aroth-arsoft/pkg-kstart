# Makefile for kstart
# $Id$

srcdir		= @srcdir@
VPATH		= @srcdir@

PACKAGE		= @PACKAGE_TARNAME@
VERSION		= @PACKAGE_VERSION@
TARDIR		= $(PACKAGE)-$(VERSION)
TARNAME		= $(TARDIR).tar

prefix		= @prefix@
exec_prefix	= @exec_prefix@

bindir		= @bindir@
mandir		= @mandir@

CC		= @CC@
CFLAGS		= @CFLAGS@
CPPFLAGS	= -I. -I$(srcdir) @CPPFLAGS@
LDFLAGS		= @LDFLAGS@
LIBS		= @LIBS@
LIBOBJS		= @LIBOBJS@
KRBLIBS		= @KRBLIBS@ $(LIBS)
KRB5LIBS	= @KRB5LIBS@ $(LIBS)

INSTALL		= @INSTALL@
INSTALL_DATA	= @INSTALL_DATA@
INSTALL_PROGRAM	= @INSTALL_PROGRAM@

K4START		= @K4START@
K4START_MAN	= @K4START_MAN@

.c.o:
	$(CC) -c $(CPPFLAGS) $(DEFS) $(CFLAGS) $<

all: k5start k5start.1 $(K4START) $(K4START_MAN)

warnings:
	$(MAKE) CFLAGS="-g -O -Wall"

install: k4start k5start $(srcdir)/k4start.1 $(srcdir)/k5start.1
	$(INSTALL) -d $(bindir) $(mandir)/man1
	$(INSTALL_PROGRAM) k5start $(bindir)/k5start
	$(INSTALL_DATA) $(srcdir)/k5start.1 $(mandir)/man1/k5start.1
	set -e; if test x"$(K4START)" != x ; then \
	    $(INSTALL_PROGRAM) k4start $(bindir)/k4start; \
	    $(INSTALL_DATA) $(srcdir)/k4start.1 $(mandir)/man1/k4start.1; \
	fi

k4start: k4start.o command.o $(LIBOBJS)
	$(CC) $(LDFLAGS) -o k4start k4start.o command.o $(LIBOBJS) $(KRBLIBS)

k5start: k5start.o command.o $(LIBOBJS)
	$(CC) $(LDFLAGS) -o k5start k5start.o command.o $(LIBOBJS) $(KRB5LIBS)

$(srcdir)/k4start.1: $(srcdir)/k4start.pod
	pod2man --release=$(VERSION) --center="User commands" $< > $@

$(srcdir)/k5start.1: $(srcdir)/k5start.pod
	pod2man --release=$(VERSION) --center="User commands" $< > $@

clean:
	rm -f *.o k4start k5start

distclean: clean
	rm -f Makefile config.cache config.h config.log config.status
	rm -f rsync-exclude
	rm -rf autom4te.cache $(TARDIR)

maintclean: distclean
	rm -f config.h.in config.h.in~ configure k4start.1 k5start.1
	rm -f $(TARNAME).gz $(TARNAME).gz.md5
	rm -f *.orig.tar.gz

dist: $(srcdir)/k4start.1 $(srcdir)/k5start.1
	rm -rf $(TARNAME).gz $(TARNAME).gz.md5 $(TARDIR)
	mkdir $(TARDIR)
	rsync -C --exclude /debian/ -a $(srcdir)/ $(TARDIR)/
	cd $(TARDIR) && autoconf && autoheader && rm -rf autom4te.cache
	tar cf $(TARNAME) $(TARDIR)
	gzip -9 $(TARNAME)
	md5sum $(TARNAME).gz > $(TARNAME).gz.md5

# Dependencies (hand-generated for now).
command.o: command.c command.h
daemon.o: daemon.c config.h
k4start.o: k4start.c command.h config.h
k5start.o: k5start.c command.h config.h
lifetime.o: lifetime.c config.h
mkstemp.o: mkstemp.c config.h
