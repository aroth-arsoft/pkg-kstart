=head1 NAME

k4start - Obtain and optionally keep active a Kerberos v4 ticket

=head1 SYNOPSIS

B<k4start> [B<-bhnqstv>] [B<-f> I<srvtab>] [B<-H> I<minutes>]
    [B<-I> I<service instance>] [B<-i> I<client instance>]
    [B<-K> I<minutes>] [B<-k> I<ticket file>] [B<-l> I<minutes>]
    [B<-p> I<pid file>] [B<-r> I<service realm>] [B<-S> I<service name>]
    [B<-u> I<client principal>] [I<username> [I<command> ...]]

=head1 DESCRIPTION

B<k4start> obtains and caches an initial Kerberos v4 ticket-granting
ticket for a principal.  B<k4start> can be used as an alternative to
kinit, but it is primarily intended to be used by programs that want to
use a srvtab to obtain Kerberos credentials, such as a web server that
needs to authenticate to another service such as an LDAP server or to AFS.

Normally, the principal for which to give tickets should be specified as
the first argument.  The B<-u> and B<-i> options can be used as an
alternative mechanism for specifying the principal, but generally aren't
as convenient.  If no username is given as either the first argument or
the argument to the B<-u> option, the client principal defaults to the
Unix username of the user running B<k4start> in the default local realm.

Optionally, a command may be given on the command line of B<k4start>.  If
so, that command is run after Kerberos authentication (and running
B<aklog> if desired), with the appropriate environment variables set to
point it to the right ticket cache.  B<k4start> will then continue
running, waking up periodically to refresh credentials slightly before
they would expire, until the command completes.  (The frequency with which
it wakes up to refresh credentials can still be controlled with the B<-K>
option.)  To run in this mode, the principal must be specified as a
regular command-line argument rather than using the B<-u> and B<-i>
options and a srvtab must be specified with B<-f>.

The command will not be run using the shell, so if you want to use shell
metacharacters in the command with their special meaning, give C<sh -c
I<command>> as the command to run and quote I<command>.

If the command contains command-line options (like C<-c>), put -- on the
command line before the beginning of the command to tell B<k4start> to not
parse those options as its own.

=head1 OPTIONS

=over 4

=item B<-b>

After starting, detach from the controlling terminal and run in the
background.  This option only makes sense in combination with B<-K> or a
command that B<k4start> will be running and can only be used if a srvtab
is specified with F<-f>.  B<k4start> will not background itself until
after it does the initial authentication, so that any initial errors will
be reported, but it will then redirect output to F</dev/null> and no
subsequent errors will be reported.

If used in conjunction with a command to run, that command will also run
in the background and will also have its input and output redirected to
F</dev/null>.  It will have to report any errors via some other mechanism
for the errors to be seen.

=item B<-f> I<srvtab>
	
Authenticate using the srvtab I<srvtab> rather than asking for a password.

=item B<-H> I<minutes>

Check for a happy ticket, one that has a remaining lifetime of at least
I<minutes> minutes.  If such a ticket is found, exit immediately with
status 0.  Otherwise, try to obtain a new ticket.

=item B<-h>

Display a usage message and exit.

=item B<-I> I<service instance>

The instance portion of the service principal.  The default is the default
realm of the machine.  Note that unlike the client principal, a
non-default service principal must be specified with B<-I> and B<-S>; one
cannot provide the instance portion as part of the argument to B<-S>.

=item B<-i> I<client instance>

Specifies the instance portion of the principal.  This option doesn't make
sense except in combination with B<-u>.  Note that the instance can be
specified as part of I<username> through the normal convention of
appending a period and then the instance, so one never has to use this
option.

=item B<-K> I<minutes>
	
Run in daemon mode to keep a ticket alive indefinitely.  The program
reawakens after I<minutes> minutes, checks if the ticket will expire
before the next wakeup, and gets a new ticket if needed.

=item B<-k> I<ticket file>

Use I<ticket file> as the ticket cache rather than the contents of the
environment variable KRBTKFILE or the library default.

=item B<-l> I<minutes>

Set the ticket lifetime in minutes.  Note that if the ticket lifetime will
only be accurate to within five minutes, may be approximate if the ticket
lifetime is over ten hours, and cannot be more than about 21 hours unless
your Kerberos libraries support long ticket lifetimes.

=item B<-n>
	
Regardless of the setting of the environment variable KINIT_PROG, don't
run the program.

=item B<-p> I<pid file>

Save the process ID (PID) of the running B<k4start> process into I<pid
file>.  I<pid file> is created if it doesn't exist and overwritten if it
does exist.  This option is most useful in conjunction with B<-b> to allow
management of the running B<k4start> daemon.

Note that, when used with B<-b> the PID file is written out after
B<k4start> is backgrounded and changes its working directory to F</>, so
relative paths for the PID file will be relative to F</> (probably not
what you want).

=item B<-q>
	
Quiet.  Suppresses the printing of the initial banner message saying what
Kerberos principal tickets are being obtained for, and also suppresses the
password prompt when the B<-s> option is given.

=item B<-r> I<service realm>

The realm for the service principal.  This defaults to the default local
realm.

=item B<-S> I<service name>

Specifies the principal for which B<k4start> is getting a service ticket.
The default value is C<krbtgt>, to obtain a ticket-granting ticket.  This
option (along with B<-I>) may be used if one only needs access to a single
service.  Note that unlike the client principal, a non-default service
principal must be specified with both B<-S> and B<-I>; one cannot provide
the instance portion as part of the argument to B<-S>.

=item B<-s>
	
Read the password from standard input.  This bypasses the normal password
prompt, which means echo isn't suppressed and input isn't forced to be
from the controlling terminal.  Most uses of this option are a security
risk.  You normally want to use a srvtab and the B<-f> option intead.

=item B<-t>
	
Run an external program after getting a TGT.  The default use of this is
to run B<aklog> to get a token.  If the environment variable KINIT_PROG is
set, the program is run regardless of the B<-t> flag (unless the B<-n>
flag is given).

=item B<-u> I<client principal>

This specifies the principal to obtain credentials as.  The entire
principal may be specified here, or alternatively just the first portion
may be specified with this flag and the instance specified with B<-i>.

Note that there's normally no reason to use this flag rather than simply
giving the principal on the command line as the first regular argument.

=item B<-v>
	
Be verbose.  This will print out a bit of additional information about
what is being attempted and what the results are.

=back

=head1 RETURN VALUES

The program exits with status 0 if it successfully gets a ticket or has a
happy ticket (see B<-H>).  If B<k4start> runs aklog or some other program
B<k4start> returns the exit status of that program.

=head1 EXAMPLES

Use the F</etc/srvtab> srvtab to obtain a ticket granting ticket for the
principal rcmd.example, putting the ticket cache in F</tmp/service.tgt>.
The lifetime is 600 minutes and the program wakes up every 10 minutes to
check if the ticket is about to expire.

    k4start -k /tmp/service.tgt -f /etc/srvtab -K 10 -l 600 \
        rcmd.example

Do the same, but using the default ticket cache and run the command
/usr/local/bin/auth-backup.  B<k4start> will continue running until the
command finishes.

    k4start -f /etc/srvtab -K 10 -l 600 rcmd.example \
        /usr/local/bin/auth-backup

Shows the permissions of the temporary cache file created by B<k4start>:

    k4start -f /etc/srvtab rcmd.example \
        -- sh -c 'ls -l $KRBTKFILE'

Notice the C<--> before the command to keep B<k4start> from parsing the
C<-c> as its own option.

Starts B<k4start> as a daemon using the Debian B<start-stop-daemon>
management program.  This is the sort of line that one could put into a
Debian init script:

    start-stop-daemon --start --pidfile /var/run/k4start.pid \
        --exec /usr/local/bin/k4start -- -b -p /var/run/k4start.pid \
        -f /etc/srvtab rcmd.example

This uses F</var/run/k4start.pid> as the PID file and obtains rcmd.example
tickets from the system srvtab file.  B<k4start> would then be stopped
with:

    start-stop-daemon --stop --pidfile /var/run/k4start.pid
    rm -f /var/run/k4start.pid

This code could be added to an init script for Apache, for example, to
start a B<k4start> process alongside Apache to manage its Kerberos
credentials.

=head1 ENVIRONMENT

If the environment variable KINIT_PROG is set to a program (such as
B<aklog>) then this program will automatically be executed after the
ticket granting ticket has been retrieved.

If no ticket file (with B<-k>) or command is specified on the command
line, B<k4start> will use the environment variable KRBTKTFILE to determine
the location of the the ticket granting ticket.  If either a command is
specified or the B<-k> option is used, KRBTKFILE will be set to point to
that file before running the B<aklog> program or any command given on the
command line.

=head1 FILES

The default ticket cache is determined by the underlying Kerberos
libraries.  The default path for aklog is determined at build time, and
will normally be whichever of B<aklog> or B<afslog> is found in the user's
path.

If a command is specified and B<-k> was not given, B<k4start> will create
a temporary ticket cache file of the form C</tmp/tkt%d_%s> where %d is the
UID B<k4start> is running as and %s is a random string.

=head1 SEE ALSO

k5start(1), kinit(1)

The kstart web page at L<http://www.eyrie.org/~eagle/software/kstart/>
will have the current version of B<k4start> and B<k5start>.

=head1 AUTHORS

B<k4start> was originally written by Robert Morgan.  Modifications and
additional features were added by Booker C. Bense.  Additional cleanup and
current maintenance are done by Russ Allbery <rra@stanford.edu>.

Implementations of B<-b> and B<-p> and the example for a Debian init
script are based on code contributed by Navid Golpayegani.

=cut
